name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Deploy the backend service if changes are detected or if manually dispatched.
  deploy-backend:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy backend to Railway
        uses: bervProject/railway-deploy@main
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          service: backend

  # Deploy the frontend service if changes are detected or if manually dispatched.
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy frontend to Railway
        uses: bervProject/railway-deploy@main
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        with:
          service: frontend

  # Perform a health check on the backend after deployment.
  health-check-backend:
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: always() && needs.deploy-backend.result == 'success'
    steps:
      - name: Wait for backend deployment to stabilize
        run: sleep 60

      - name: Health check backend with retries
        run: |
          echo "Checking backend health..."
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts"
            if curl -f -s --max-time 30 https://sol-evaluation-system.up.railway.app/api/health; then
              echo "✅ Backend health check passed"
              exit 0
            else
              echo "❌ Backend health check failed"
              if [ $attempt -eq $max_attempts ]; then
                echo "💥 Backend health check failed after $max_attempts attempts"
                exit 1
              fi
              echo "Waiting 30 seconds before retry..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done

  # Perform a health check on the frontend after deployment.
  health-check-frontend:
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: always() && needs.deploy-frontend.result == 'success'
    steps:
      - name: Wait for frontend deployment to stabilize
        run: sleep 60

      - name: Health check frontend with retries
        run: |
          echo "Checking frontend health..."
          max_attempts=5
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts"
            if curl -f -s --max-time 30 https://frontend-production-d9f6.up.railway.app/; then
              echo "✅ Frontend health check passed"
              exit 0
            else
              echo "❌ Frontend health check failed"
              if [ $attempt -eq $max_attempts ]; then
                echo "💥 Frontend health check failed after $max_attempts attempts"
                exit 1
              fi
              echo "Waiting 30 seconds before retry..."
              sleep 30
            fi
            attempt=$((attempt + 1))
          done

  # Integration health check (when both services are deployed)
  integration-health-check:
    runs-on: ubuntu-latest
    needs: [health-check-backend, health-check-frontend]
    if: always() && needs.health-check-backend.result == 'success' && needs.health-check-frontend.result == 'success'
    steps:
      - name: Run integration health check
        run: |
          echo "Running integration health check..."
          # A simple check to see if the frontend page contains expected content.
          if curl -f -s --max-time 30 "https://frontend-production-d9f6.up.railway.app/" | grep -q "evaluation"; then
            echo "✅ Frontend-to-Backend integration check passed"
          else
            echo "❌ Frontend-to-Backend integration check failed"
            exit 1
          fi

  # Summary job
  deployment-summary:
    runs-on: ubuntu-latest
    needs:
      [
        changes,
        deploy-backend,
        deploy-frontend,
        health-check-backend,
        health-check-frontend,
        integration-health-check,
      ]
    if: always()
    steps:
      - name: Generate deployment summary
        run: |
          echo "# 📋 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          # Backend Status
          if [[ "${{ needs.changes.outputs.backend }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
              echo "✅ **Backend**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "  - Health check: ${{ needs.health-check-backend.result == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Backend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **Backend**: No changes, skipped" >> $GITHUB_STEP_SUMMARY
          fi
          # Frontend Status
          if [[ "${{ needs.changes.outputs.frontend }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
              echo "✅ **Frontend**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
              echo "  - Health check: ${{ needs.health-check-frontend.result == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Frontend**: Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **Frontend**: No changes, skipped" >> $GITHUB_STEP_SUMMARY
          fi
          # Integration Status
          if [[ "${{ needs.integration-health-check.result }}" == "success" ]]; then
            echo "✅ **Integration**: All systems working together" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.integration-health-check.result }}" == "failure" ]]; then
            echo "❌ **Integration**: Systems deployed but integration failed" >> $GITHUB_STEP_SUMMARY
          fi
